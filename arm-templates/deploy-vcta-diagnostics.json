{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "managementGroupId": {
      "type": "string"
    },
    "storageAccount": {
      "type": "string",
      "metadata": {
        "strongType": "Microsoft.Storage/storageAccounts"
      }
    },
    "tagName": {
      "type": "string",
      "metadata": {
        "displayName": "The VM tag name to match"
      }
    },
    "tagValue": {
      "type": "array",
      "metadata": {
        "displayName": "The VM tag value(s) to match"
      }
    }
  },
  "variables": {
    "policyPrefix": "deploy-vcta-diagnostics",
    "storageAccount": {
      "name": "[last(split(parameters('storageAccount'), '/'))]",
      "resourceGroup": "[split(parameters('storageAccount'), '/')[4]]",
      "subscriptionId": "[split(parameters('storageAccount'), '/')[2]]"
    },
    "managementGroup": "[tenantResourceId('Microsoft.Management/managementGroups', parameters('managementGroupId'))]",
    "policyAssignment": "[extensionResourceId(variables('managementGroup'), 'Microsoft.Authorization/policyAssignments', variables('policyPrefix'))]",
    "policyDefinitions": [
      "[extensionResourceId(variables('managementGroup'), 'Microsoft.Authorization/policyDefinitions', concat(variables('policyPrefix'), '-windows'))]"
    ],
    "policySetDefinition": "[extensionResourceId(variables('managementGroup'), 'Microsoft.Authorization/policySetDefinitions', variables('policyPrefix'))]",
    "roleDefinitions": {
      "vmcontributor": "[tenantResourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
      "datareader": "[tenantResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/policyDefinitions",
      "name": "[concat(variables('policyPrefix'), '-windows')]",
      "apiVersion": "2020-09-01",
      "properties": {
        "displayName": "Deploy diagnostic settings to Windows VMs for the Secureworks vCTA",
        "policyType": "Custom",
        "description": "This policy deploys the Azure diagnostics extension to Windows VMs matching a specific tag-value pair, to enable log collection in Secureworks using the vCTA",
        "metadata": {
          "category": "Compute"
        },
        "parameters": {
          "storageAccount": {
            "type": "string",
            "metadata": {
              "displayName": "Resource ID of the storage account to use for logging",
              "strongType": "Microsoft.Storage/storageAccounts"
            }
          },
          "tagName": {
            "type": "string",
            "metadata": {
              "displayName": "The VM tag name to match"
            }
          },
          "tagValue": {
            "type": "array",
            "metadata": {
              "displayName": "The VM tag value(s) to match"
            }
          }
        },
        "mode": "Indexed",
        "policyRule": {
          "if": {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                "equals": "Windows"
              },
              {
                "field": "[[concat('tags[', parameters('tagName'), ']')]",
                "in": "[[parameters('tagValue')]"
              }
            ]
          },
          "then": {
            "effect": "deployIfNotExists",
            "details": {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "roleDefinitionIds": [
                "[variables('roleDefinitions').vmcontributor]"
              ],
              "existenceCondition": {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/virtualMachines/extensions/type",
                    "equals": "IaaSDiagnostics"
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                    "equals": "Microsoft.Azure.Diagnostics"
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                    "equals": "Succeeded"
                  }
                ]
              },
              "deployment": {
                "properties": {
                  "mode": "incremental",
                  "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                      "vmName": {
                        "type": "string"
                      },
                      "storageAccount": {
                        "type": "string",
                        "metadata": {
                          "strongType": "Microsoft.Storage/storageAccounts"
                        }
                      },
                      "now": {
                        "type": "string",
                        "defaultValue": "[[utcNow('yyyy-MM-dd''T''HH:mm:ssZ')]"
                      }
                    },
                    "variables": {
                      "sasProperties": {
                        "signedServices": "bt",
                        "signedPermission": "acuw",
                        "signedExpiry": "[[dateTimeAdd(parameters('now'), 'P30Y')]",
                        "signedResourceTypes": "co",
                        "signedProtocol": "https",
                        "keyToSign": "key1"
                      },
                      "storageAccountName": "[[last(split(parameters('storageAccount'), '/'))]"
                    },
                    "resources": [
                      {
                        "name": "[[concat(parameters('vmName'), '/Microsoft.Insights.VMDiagnosticsSettings')]",
                        "type": "Microsoft.Compute/virtualMachines/extensions",
                        "location": "[[resourceGroup().location]",
                        "apiVersion": "2020-12-01",
                        "tags": {
                          "displayName": "AzureDiagnostics"
                        },
                        "properties": {
                          "publisher": "Microsoft.Azure.Diagnostics",
                          "type": "IaaSDiagnostics",
                          "typeHandlerVersion": "1.18",
                          "autoUpgradeMinorVersion": true,
                          "settings": {
                            "WadCfg": {
                              "DiagnosticMonitorConfiguration": {
                                "overallQuotaInMB": 5120,
                                "WindowsEventLog": {
                                  "scheduledTransferPeriod": "PT1M",
                                  "DataSource": [
                                    {
                                      "name": "Application!*[System[(Level=1 or Level=2 or Level=3 or Level=4 or Level=5)]]"
                                    },
                                    {
                                      "name": "System!*[System[(Level=1 or Level=2 or Level=3 or Level=4 or Level=5)]]"
                                    },
                                    {
                                      "name": "Security!*[System[(band(Keywords,13510798882111488))]]"
                                    }
                                  ]
                                },
                                "PerformanceCounters": {
                                  "scheduledTransferPeriod": "PT1M",
                                  "PerformanceCounterConfiguration": []
                                },
                                "Directories": {
                                  "scheduledTransferPeriod": "PT1M"
                                },
                                "Metrics": {
                                  "resourceId": "[[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                                  "MetricAggregation": [
                                    {
                                      "scheduledTransferPeriod": "PT1H"
                                    },
                                    {
                                      "scheduledTransferPeriod": "PT1M"
                                    }
                                  ]
                                }
                              }
                            },
                            "StorageAccount": "[[variables('storageAccountName')]",
                            "StorageType": "Blob"
                          },
                          "protectedSettings": {
                            "storageAccountName": "[[variables('storageAccountName')]",
                            "storageAccountEndpoint": "[[concat('https://', environment().suffixes.storage)]",
                            "storageAccountSasToken": "[[listAccountSas(parameters('storageAccount'), '2019-06-01', variables('sasProperties')).accountSasToken]"
                          }
                        }
                      }
                    ]
                  },
                  "parameters": {
                    "vmName": {
                      "value": "[[field('fullName')]"
                    },
                    "storageAccount": {
                      "value": "[[parameters('storageAccount')]"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Authorization/policySetDefinitions",
      "name": "[variables('policyPrefix')]",
      "apiVersion": "2020-09-01",
      "dependsOn": [
        "[variables('policyDefinitions')[0]]"
      ],
      "properties": {
        "displayName": "Deploy diagnostic settings to VMs for the Secureworks vCTA",
        "policyType": "Custom",
        "description": "This policy initiative deploys the Azure diagnostics extension to VMs matching a specific tag-value pair to enable log collection in Secureworks using the vCTA",
        "metadata": {
          "category": "Compute"
        },
        "parameters": {
          "storageAccount": {
            "type": "string",
            "metadata": {
              "displayName": "Resource ID of the storage account to use for logging",
              "strongType": "Microsoft.Storage/storageAccounts"
            }
          },
          "tagName": {
            "type": "string",
            "metadata": {
              "displayName": "The VM tag name to match"
            }
          },
          "tagValue": {
            "type": "array",
            "metadata": {
              "displayName": "The VM tag value(s) to match"
            }
          }
        },
        "copy": [
          {
            "name": "policyDefinitions",
            "count": "[length(variables('policyDefinitions'))]",
            "input": {
              "policyDefinitionId": "[variables('policyDefinitions')[copyIndex('policyDefinitions')]]",
              "parameters": {
                "storageAccount": {
                  "value": "[[parameters('storageAccount')]"
                },
                "tagName": {
                  "value": "[[parameters('tagName')]"
                },
                "tagValue": {
                  "value": "[[parameters('tagValue')]"
                }
              }
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "name": "deploy-vcta-diagnostics",
      "apiVersion": "2020-09-01",
      "location": "eastus",
      "dependsOn": [
        "[variables('policySetDefinition')]"
      ],
      "properties": {
        "displayName": "Deploy diagnostic settings to VMs for the Secureworks vCTA",
        "policyDefinitionId": "[variables('policySetDefinition')]",
        "scope": "[variables('managementGroup')]",
        "parameters": {
          "storageAccount": {
            "value": "[parameters('storageAccount')]"
          },
          "tagName": {
            "value": "[parameters('tagName')]"
          },
          "tagValue": {
            "value": "[parameters('tagValue')]"
          }
        }
      },
      "sku": {
        "name": "A0",
        "tier": "Free"
      },
      "identity": {
        "type": "SystemAssigned"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "name": "[guid(concat(variables('managementGroup'), '/', variables('roleDefinitions').vmcontributor))]",
      "apiVersion": "2020-04-01-preview",
      "dependsOn": [
        "[variables('policyAssignment')]"
      ],
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitions').vmcontributor]",
        "principalId": "[reference(variables('policyAssignment'), '2020-09-01', 'Full').identity.principalId]"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "storage-account-roleassignment",
      "dependsOn": [
        "[variables('policyAssignment')]"
      ],
      "resourceGroup": "[variables('storageAccount').resourceGroup]",
      "subscriptionId": "[variables('storageAccount').subscriptionId]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/providers/roleAssignments",
              "name": "[concat(variables('storageAccount').name, '/Microsoft.Authorization/', guid(concat(parameters('storageAccount'), '/', variables('roleDefinitions').datareader)))]",
              "apiVersion": "2020-04-01-preview",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitions').datareader]",
                "principalId": "[reference(variables('policyAssignment'), '2020-09-01', 'Full').identity.principalId]"
              }
            }
          ]
        }
      }
    }
  ]
}
